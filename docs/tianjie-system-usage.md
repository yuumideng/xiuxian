# å¤©åŠ«ç³»ç»Ÿä½¿ç”¨è¯´æ˜

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. æ ¸å¿ƒç»„ä»¶
- âœ… `TianJieModal.vue` - å¤©åŠ«ä¸»å¼¹çª—
- âœ… `TianJieBattleDetail.vue` - æˆ˜æ–—è¯¦æƒ…å¼¹çª—
- âœ… é›†æˆåˆ° `PlayerCard.vue` çš„å¤©é“è½®å›åŠ«æŒ‰é’®

### 2. Store æ•°æ®ç»“æ„
```javascript
player.tianJie = {
  currentFloor: 0,              // å½“å‰å·²é€šè¿‡çš„å¤©åŠ«å±‚æ•°
  nextPassiveTime: 10000 * 365, // ä¸‹æ¬¡è¢«åŠ¨å¤©åŠ«é™ä¸´æ—¶é—´ï¼ˆå¤©ï¼‰
  passiveInterval: 10000 * 365, // è¢«åŠ¨å¤©åŠ«é—´éš”ï¼ˆ10000å¹´ï¼‰
  isPassiveTriggered: false,    // æ˜¯å¦è§¦å‘è¢«åŠ¨å¤©åŠ«
  totalChallenges: 0,           // æ€»æŒ‘æˆ˜æ¬¡æ•°
  totalVictories: 0,            // æ€»èƒœåˆ©æ¬¡æ•°
  totalDefeats: 0               // æ€»å¤±è´¥æ¬¡æ•°
}
```

### 3. æ ¸å¿ƒåŠŸèƒ½

#### ä¸»åŠ¨è¿æˆ˜å¤©åŠ«ï¼ˆè¯¦ç»†æ¨¡å¼ï¼‰
- ç‚¹å‡»"ä¸»åŠ¨è¿æˆ˜å¤©åŠ«"æŒ‰é’®
- æ‰“å¼€æˆ˜æ–—è¯¦æƒ…å¼¹çª—
- æ˜¾ç¤ºå®æ—¶æˆ˜æ–—æ—¥å¿—
- æ˜¾ç¤ºåŒæ–¹å±æ€§å¯¹æ¯”
- éœ€è¦ç‚¹å‡»"ç¡®å®š"å…³é—­å¼¹çª—

#### å¿«é€Ÿä¸»åŠ¨è¿æˆ˜å¤©åŠ«
- ç‚¹å‡»"å¿«é€Ÿä¸»åŠ¨è¿æˆ˜å¤©åŠ«"æŒ‰é’®
- ä¸æ‰“å¼€è¯¦æƒ…å¼¹çª—
- ç›´æ¥åœ¨å½“å‰å¼¹çª—æ˜¾ç¤ºç»“æœæç¤º
- 3ç§’åè‡ªåŠ¨æ¶ˆå¤±

#### è¿ç»­æˆ˜æ–—
- å‹¾é€‰"è¿ç»­æˆ˜æ–—"å¤é€‰æ¡†
- ç‚¹å‡»"å¿«é€Ÿä¸»åŠ¨è¿æˆ˜å¤©åŠ«"
- è‡ªåŠ¨è¿ç»­æŒ‘æˆ˜ç›´åˆ°å¤±è´¥
- æ¯æ¬¡æˆ˜æ–—é—´éš”0.5ç§’

#### è¢«åŠ¨å¤©åŠ«
- å€’è®¡æ—¶å½’é›¶æ—¶è‡ªåŠ¨è§¦å‘
- æ¸¸æˆæš‚åœ
- å¿…é¡»é€šè¿‡æ‰èƒ½ç»§ç»­æ¸¸æˆ
- å¤±è´¥åä¸èƒ½å…³é—­å¼¹çª—

## ğŸ® ä½¿ç”¨æµç¨‹

### 1. æ‰“å¼€å¤©åŠ«å¼¹çª—
```vue
<!-- åœ¨ PlayerCard.vue ä¸­ -->
<GameButton color="red" @click="showTianJieModal = true">
  <span>å¤©é“è½®å›åŠ«</span>
  <span class="text-xs">ç¬¬{{ gameStore.player.tianJie.currentFloor + 1 }}åŠ«</span>
</GameButton>
```

### 2. ä¸»åŠ¨æŒ‘æˆ˜
```javascript
// è¯¦ç»†æ¨¡å¼
handleActiveBattle() {
  // è®¡ç®—ç©å®¶å±æ€§
  const playerAttrs = calculateBattleAttributes(gameStore.player)
  
  // ç”Ÿæˆæ•Œäºº
  const enemy = generateTowerEnemy(playerAttrs, nextFloor)
  
  // æ‰§è¡Œæˆ˜æ–—
  const result = executeBattle(playerAttrs, enemy, true)
  
  // æ‰“å¼€è¯¦æƒ…å¼¹çª—
  showBattleDetail.value = true
}

// å¿«é€Ÿæ¨¡å¼
handleQuickBattle() {
  const result = executeBattle(playerAttrs, enemy, false)
  
  if (result.victory) {
    gameStore.activeTianJieSuccess(nextFloor)
  } else {
    gameStore.activeTianJieFailure()
  }
}
```

### 3. è¢«åŠ¨å¤©åŠ«è§¦å‘
```javascript
// åœ¨ processGameGains ä¸­è‡ªåŠ¨æ£€æŸ¥
this.player.tianJie.nextPassiveTime -= ageDays

if (this.player.tianJie.nextPassiveTime <= 0) {
  this.triggerPassiveTianJie() // æš‚åœæ¸¸æˆï¼Œæ‰“å¼€å¼¹çª—
}
```

## ğŸ“Š æ•°æ®æµè½¬

### ä¸»åŠ¨å¤©åŠ«æˆåŠŸ
```
1. ç©å®¶ç‚¹å‡»"ä¸»åŠ¨è¿æˆ˜å¤©åŠ«"
2. ç”Ÿæˆç¬¬ N+1 å±‚æ•Œäºº
3. æ‰§è¡Œæˆ˜æ–—
4. æˆ˜æ–—èƒœåˆ©
5. è°ƒç”¨ gameStore.activeTianJieSuccess(N+1)
6. æ›´æ–° currentFloor = N+1
7. é‡æ–°è®¡ç®— nextPassiveTime = (N+1) Ã— 10000å¹´
```

### è¢«åŠ¨å¤©åŠ«æˆåŠŸ
```
1. å€’è®¡æ—¶å½’é›¶ï¼Œè§¦å‘è¢«åŠ¨å¤©åŠ«
2. æ¸¸æˆæš‚åœï¼Œæ‰“å¼€å¼¹çª—
3. ç©å®¶å¿…é¡»æŒ‘æˆ˜ç¬¬ N+1 å±‚
4. æˆ˜æ–—èƒœåˆ©
5. è°ƒç”¨ gameStore.passiveTianJieSuccess()
6. æ›´æ–° currentFloor = N+1
7. é‡æ–°è®¡ç®— nextPassiveTime = (N+1) Ã— 10000å¹´
8. æ¢å¤æ¸¸æˆ
```

### è¢«åŠ¨å¤©åŠ«å¤±è´¥
```
1. æˆ˜æ–—å¤±è´¥
2. å¼¹çª—ä¸å…³é—­
3. æ¸¸æˆç»§ç»­æš‚åœ
4. ç©å®¶å¿…é¡»ç»§ç»­æŒ‘æˆ˜ç›´åˆ°æˆåŠŸ
```

## ğŸ¯ å…³é”®é€»è¾‘

### å€’è®¡æ—¶è®¡ç®—
```javascript
// åˆå§‹çŠ¶æ€ï¼šç¬¬0åŠ«ï¼Œ10000å¹´åç¬¬1åŠ«é™ä¸´
nextPassiveTime = 10000 * 365 å¤©

// ä¸»åŠ¨æ‰“è¿‡ç¬¬1åŠ«ï¼šç¬¬1åŠ«ï¼Œ20000å¹´åç¬¬2åŠ«é™ä¸´
nextPassiveTime = 2 Ã— 10000 * 365 å¤©

// ä¸»åŠ¨æ‰“è¿‡ç¬¬100åŠ«ï¼šç¬¬100åŠ«ï¼Œ1010000å¹´åç¬¬101åŠ«é™ä¸´
nextPassiveTime = 101 Ã— 10000 * 365 å¤©
```

### æ•Œäººç”Ÿæˆ
```javascript
// ä½¿ç”¨ generateTowerEnemy
const enemy = generateTowerEnemy(playerAttrs, floor)

// è§„åˆ™ï¼š
// - åŸºç¡€æˆ˜åŠ› = 50% + (floor - 1) Ã— 1.5%
// - æ¯8å±‚è½®æ¢ä¸€ä¸ªå¼ºåŒ–å±æ€§
// - å¼ºåŒ–å±æ€§é¢å¤– +30%
```

### æˆ˜æ–—æ‰§è¡Œ
```javascript
// ä½¿ç”¨ executeBattle
const result = executeBattle(playerAttrs, enemyAttrs, detailed)

// è¿”å›ï¼š
// {
//   victory: true/false,
//   rounds: å›åˆæ•°,
//   playerFinalHp: ç©å®¶å‰©ä½™HP,
//   enemyFinalHp: æ•Œäººå‰©ä½™HP,
//   battleLog: æˆ˜æ–—æ—¥å¿—ï¼ˆè¯¦ç»†æ¨¡å¼ï¼‰
// }
```

## ğŸ”§ å¾…å¼€å‘åŠŸèƒ½

### 1. å¤©åŠ«æ·¬ä½“
- æŒ‰é’®å·²é¢„ç•™
- éœ€è¦è®¾è®¡æ·¬ä½“ç¢ç‰‡ç³»ç»Ÿ
- éœ€è¦è®¾è®¡å±æ€§æå‡ç•Œé¢

### 2. å¿ƒé­”&å¤©åŠ«æ’è¡Œæ¦œ
- æŒ‰é’®å·²é¢„ç•™
- éœ€è¦è®¾è®¡æ’è¡Œæ¦œæ•°æ®ç»“æ„
- éœ€è¦è®¾è®¡æ’è¡Œæ¦œç•Œé¢

### 3. æ¬¡æ•°é™åˆ¶
- å½“å‰æ˜¾ç¤º"æ— é™æ¬¡"
- éœ€è¦æ ¹æ®ç©å®¶æƒé™é™åˆ¶æ¬¡æ•°
- éœ€è¦è®¾è®¡å……å€¼å¡ç³»ç»Ÿ

### 4. å¥–åŠ±ç³»ç»Ÿ
- å½“å‰åªæœ‰ç®€å•çš„ç¢ç‰‡å¥–åŠ±
- éœ€è¦è®¾è®¡å®Œæ•´çš„å¥–åŠ±æœºåˆ¶
- å¯èƒ½åŒ…æ‹¬ï¼šä¿®ä¸ºã€çµçŸ³ã€è£…å¤‡ç­‰

## ğŸ› å·²çŸ¥é—®é¢˜

### 1. è¢«åŠ¨å¤©åŠ«å¼¹çª—
- å½“å‰è¢«åŠ¨å¤©åŠ«è§¦å‘æ—¶ä¼šè‡ªåŠ¨æ‰“å¼€å¼¹çª—
- å¦‚æœç©å®¶å·²ç»æ‰“å¼€äº†å¼¹çª—ï¼Œå¯èƒ½ä¼šæœ‰å†²çª
- å»ºè®®ï¼šæ·»åŠ å¼¹çª—çŠ¶æ€æ£€æŸ¥

### 2. è¿ç»­æˆ˜æ–—ä¸­æ–­
- å½“å‰è¿ç»­æˆ˜æ–—åªèƒ½é€šè¿‡å¤±è´¥ä¸­æ–­
- å»ºè®®ï¼šæ·»åŠ "åœæ­¢æˆ˜æ–—"æŒ‰é’®

### 3. æˆ˜æ–—æ—¥å¿—æ»šåŠ¨
- å½“å‰æˆ˜æ–—æ—¥å¿—ä¼šè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
- åœ¨å¿«é€Ÿæˆ˜æ–—æ—¶å¯èƒ½çœ‹ä¸æ¸…
- å»ºè®®ï¼šæ·»åŠ æš‚åœ/æ’­æ”¾æ§åˆ¶

## ğŸ“ æµ‹è¯•å»ºè®®

### 1. åŸºç¡€åŠŸèƒ½æµ‹è¯•
```javascript
// 1. æ‰“å¼€å¤©åŠ«å¼¹çª—
// 2. ç‚¹å‡»"ä¸»åŠ¨è¿æˆ˜å¤©åŠ«"
// 3. æŸ¥çœ‹æˆ˜æ–—è¯¦æƒ…
// 4. ç‚¹å‡»"ç¡®å®š"å…³é—­
// 5. æŸ¥çœ‹å¤©åŠ«å±‚æ•°æ˜¯å¦å¢åŠ 
```

### 2. å¿«é€Ÿæˆ˜æ–—æµ‹è¯•
```javascript
// 1. ç‚¹å‡»"å¿«é€Ÿä¸»åŠ¨è¿æˆ˜å¤©åŠ«"
// 2. æŸ¥çœ‹ç»“æœæç¤º
// 3. ç­‰å¾…3ç§’è‡ªåŠ¨æ¶ˆå¤±
// 4. æŸ¥çœ‹å¤©åŠ«å±‚æ•°æ˜¯å¦å¢åŠ 
```

### 3. è¿ç»­æˆ˜æ–—æµ‹è¯•
```javascript
// 1. å‹¾é€‰"è¿ç»­æˆ˜æ–—"
// 2. ç‚¹å‡»"å¿«é€Ÿä¸»åŠ¨è¿æˆ˜å¤©åŠ«"
// 3. è§‚å¯Ÿè¿ç»­æˆ˜æ–—è¿‡ç¨‹
// 4. ç­‰å¾…å¤±è´¥æˆ–æ‰‹åŠ¨åœæ­¢
```

### 4. è¢«åŠ¨å¤©åŠ«æµ‹è¯•
```javascript
// 1. ä¿®æ”¹ passiveInterval ä¸ºè¾ƒå°å€¼ï¼ˆå¦‚ 100 å¤©ï¼‰
// 2. ç­‰å¾…å€’è®¡æ—¶å½’é›¶
// 3. æŸ¥çœ‹æ¸¸æˆæ˜¯å¦æš‚åœ
// 4. æŸ¥çœ‹å¼¹çª—æ˜¯å¦è‡ªåŠ¨æ‰“å¼€
// 5. æŒ‘æˆ˜æˆåŠŸåæŸ¥çœ‹æ¸¸æˆæ˜¯å¦æ¢å¤
```

## ğŸ¨ UI ä¼˜åŒ–å»ºè®®

### 1. æˆ˜æ–—åŠ¨ç”»
- æ·»åŠ å±æ€§å˜åŒ–åŠ¨ç”»
- æ·»åŠ ä¼¤å®³æ•°å­—é£å‡ºæ•ˆæœ
- æ·»åŠ æš´å‡»ç‰¹æ•ˆ

### 2. å€’è®¡æ—¶æ˜¾ç¤º
- æ·»åŠ å€’è®¡æ—¶è¿›åº¦æ¡
- æ·»åŠ å€’è®¡æ—¶è­¦å‘Šï¼ˆå¦‚å‰©ä½™1000å¹´æ—¶ï¼‰
- æ·»åŠ å€’è®¡æ—¶åŠ¨ç”»

### 3. æˆ˜æ–—ç»“æœ
- æ·»åŠ èƒœåˆ©/å¤±è´¥åŠ¨ç”»
- æ·»åŠ å¥–åŠ±å±•ç¤ºåŠ¨ç”»
- æ·»åŠ å±æ€§æå‡åŠ¨ç”»

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. æˆ˜æ–—è®¡ç®—
- å½“å‰æ¯æ¬¡æˆ˜æ–—éƒ½é‡æ–°è®¡ç®—å±æ€§
- å»ºè®®ï¼šç¼“å­˜ç©å®¶å±æ€§ï¼Œåªåœ¨å±æ€§å˜åŒ–æ—¶é‡æ–°è®¡ç®—

### 2. æˆ˜æ–—æ—¥å¿—
- å½“å‰æˆ˜æ–—æ—¥å¿—å…¨éƒ¨ä¿å­˜åœ¨å†…å­˜ä¸­
- å»ºè®®ï¼šé™åˆ¶æ—¥å¿—æ•°é‡ï¼Œåªä¿ç•™æœ€è¿‘çš„100æ¡

### 3. è¿ç»­æˆ˜æ–—
- å½“å‰è¿ç»­æˆ˜æ–—ä¼šé˜»å¡UI
- å»ºè®®ï¼šä½¿ç”¨ Web Worker æˆ–åˆ†å¸§å¤„ç†

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æˆ˜æ–—ç³»ç»Ÿè®¾è®¡æ–‡æ¡£](./battle-system-guide.md)
- [æˆ˜æ–—ç³»ç»Ÿä½¿ç”¨ç¤ºä¾‹](./battle-system-example.js)
- [æ•°å€¼å¹³è¡¡åˆ†æ](./battle-system-guide.md#å…­å¹³è¡¡æ€§åˆ†æ)
