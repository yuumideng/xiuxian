# 战斗系统文档

## 📊 系统概述

全新的战斗属性系统，基于八大属性构建完整的回合制战斗机制。

## 🎯 八大战斗属性

### 属性定义

| 属性 | 名称 | 说明 | 基础值 | 成长率 |
|------|------|------|--------|--------|
| hp | 血量 | 生命值，归零则战斗失败 | 1000 | 100% |
| attack | 攻击 | 物理伤害基础值 | 100 | 100% |
| defense | 防御 | 减少受到的伤害 | 100 | 100% |
| speed | 速度 | 决定出手顺序和闪避率 | 100 | 95% |
| crit | 暴击 | 暴击率和暴击伤害 | 50 | 98% |
| toughness | 韧性 | 抵抗暴击和控制效果 | 50 | 98% |
| dodge | 闪避 | 躲避攻击的概率 | 30 | 92% |
| hit | 命中 | 命中目标的概率 | 80 | 95% |

### 属性成长公式

```javascript
属性值 = 基础值 × 2^((level-1)/10) × 成长率 × (1 + 战斗经验加成)
```

**核心特点**：
- 每提升1个小境界，属性增长约 **7.2%**
- 每跨越1个大境界（10级），属性累计 **翻倍**
- 战斗经验提供额外加成（最高20%）

### 成长验证数据

| 境界 | 等级 | 攻击 | 防御 | 血量 | 战斗力 | 增长率 |
|------|------|------|------|------|--------|--------|
| 练气一层 | 1 | 100 | 100 | 1000 | 270 | - |
| 练气大圆满 | 10 | 186 | 186 | 1866 | 503 | +86.3% |
| 筑基初期 | 11 | 200 | 200 | 2000 | 540 | +7.4% |
| 筑基大圆满 | 20 | 373 | 373 | 3732 | 1007 | +86.5% |
| 金丹初期 | 21 | 400 | 400 | 4000 | 1080 | +7.2% |
| 金丹大圆满 | 30 | 746 | 746 | 7464 | 2014 | +86.5% |
| 元婴初期 | 31 | 800 | 800 | 8000 | 2160 | +7.2% |
| 元婴大圆满 | 40 | 1492 | 1492 | 14928 | 4028 | +86.5% |

**规律总结**：
- ✅ 每次突破都有提升（约7.2%）
- ✅ 每个大境界内累计翻倍（约86.5%）
- ✅ 平滑增长，无跳跃或停滞

## ⚔️ 战斗力计算

### 权重分配

```javascript
战斗力 = 攻击×28% + 防御×28% + 血量×20% + 速度×6% + 暴击×6% + 韧性×6% + 闪避×3% + 命中×3%
```

**设计理念**：
- **攻防核心**（56%）：决定战斗胜负的关键
- **血量次要**（20%）：提供容错空间
- **其他属性**（24%）：影响战斗细节

### 战斗力示例

筑基大圆满(20级)：
- 攻击: 373 (权重28%) → 104.44
- 防御: 373 (权重28%) → 104.44
- 血量: 3732 (权重20%) → 746.40
- 速度: 354 (权重6%) → 21.24
- 暴击: 183 (权重6%) → 10.98
- 韧性: 183 (权重6%) → 10.98
- 闪避: 102 (权重3%) → 3.06
- 命中: 283 (权重3%) → 8.49
- **总战斗力: 1010**

## 🎮 回合制战斗机制

### 战斗流程

1. **先手判定**：速度高的先攻击
2. **命中判定**：计算是否命中
3. **暴击判定**：计算是否暴击
4. **伤害计算**：计算实际伤害
5. **回合切换**：轮到对方攻击
6. **胜负判定**：血量归零或超时

### 命中机制

```javascript
命中率 = 攻击方命中 / (攻击方命中 + 防守方闪避)
最终命中率 = 20% ~ 95% 之间
```

**特点**：
- 速度高的角色更容易闪避
- 保证最低20%命中率
- 最高95%命中率，无法100%命中

### 暴击机制

```javascript
暴击率 = (攻击方暴击 - 防守方韧性) / 攻击方暴击 × 50%
最终暴击率 = 5% ~ 50% 之间
暴击伤害 = 基础伤害 × (1.5 + 暴击/1000)
```

**特点**：
- 韧性可以降低对方暴击率
- 暴击伤害随暴击属性提升
- 最低5%暴击率，最高50%

### 伤害计算

```javascript
防御减伤 = 防御 / (防御 + 1000)
基础伤害 = 攻击 × (1 - 防御减伤)
暴击伤害 = 基础伤害 × 暴击倍率
最终伤害 = 伤害 × (0.9 ~ 1.1 随机波动)
```

**特点**：
- 防御递减机制，避免无敌
- 伤害有±10%随机波动
- 最少造成1点伤害

## 📈 战斗示例

### 同境界战斗

**筑基中期修士 VS 筑基初期巅峰修士**

属性对比：
```
筑基中期(15级):
  血量: 2378, 攻击: 237, 防御: 237
  战斗力: 642

筑基初期巅峰(14级):
  血量: 2217, 攻击: 221, 防御: 221
  战斗力: 598
```

100场战斗结果：
- 筑基中期胜率: **约60%**
- 筑基初期巅峰胜率: **约40%**
- 平均回合数: **约35回合**

### 跨境界战斗

**金丹初期修士 VS 筑基大圆满修士**

属性对比：
```
金丹初期(21级):
  血量: 4000, 攻击: 400, 防御: 400
  战斗力: 1080

筑基大圆满(20级):
  血量: 3732, 攻击: 373, 防御: 373
  战斗力: 1007
```

100场战斗结果：
- 金丹初期胜率: **约89%**
- 筑基大圆满胜率: **约11%**
- 平均回合数: **约33回合**

**结论**：刚突破的金丹初期，对筑基大圆满有明显优势，但不是碾压。

## 🔧 使用方法

### 1. 获取战斗属性

```javascript
import { useGameStore } from '@/store/gameState.js'

const gameStore = useGameStore()

// 获取八大属性
const battleAttributes = gameStore.battleAttributes

// 获取战斗力
const battlePower = gameStore.battlePower
```

### 2. 进行战斗

```javascript
import { BattleSystem } from '@/utils/battleSystem.js'

// 创建战斗
const battle = new BattleSystem(player1, player2)

// 开始战斗
const result = battle.startBattle()

// 查看结果
console.log(`获胜者: ${result.winnerName}`)
console.log(`战斗回合数: ${result.rounds}`)
console.log(`战斗日志:`, result.battleLog)
```

### 3. 模拟胜率

```javascript
import { simulateBattles } from '@/utils/battleSystem.js'

// 模拟100场战斗
const winRate = simulateBattles(player1, player2, 100)

console.log(`玩家1胜率: ${winRate.attackerWinRate}`)
console.log(`玩家2胜率: ${winRate.defenderWinRate}`)
```

## 📝 文件结构

```
src/
├── utils/
│   ├── battleCalculator.js    # 战斗属性计算器
│   └── battleSystem.js         # 回合制战斗系统
├── store/
│   └── gameState.js            # 集成战斗属性（新增 getters）
└── components/
    ├── BattleStats.vue         # 战斗数据显示
    └── PlayerCard.vue          # 玩家卡片（显示战斗力）
```

## 🎯 平衡性分析

### 优点

1. ✅ **成长平滑**：每级提升7.2%，无跳跃
2. ✅ **境界明确**：每大境界翻倍，进步感强
3. ✅ **战斗真实**：命中、闪避、暴击等机制丰富
4. ✅ **数值简洁**：基于2的幂次方，易于理解
5. ✅ **平衡性好**：跨境界有优势但不碾压

### 可调整参数

如需调整平衡性，可修改以下参数：

**属性成长**（`battleCalculator.js`）：
```javascript
const GROWTH_RATES = {
  hp: 1.0,         // 血量成长率
  attack: 1.0,     // 攻击成长率
  defense: 1.0,    // 防御成长率
  // ...
}
```

**战斗力权重**（`battleCalculator.js`）：
```javascript
const POWER_WEIGHTS = {
  attack: 0.28,    // 攻击权重
  defense: 0.28,   // 防御权重
  hp: 0.20,        // 血量权重
  // ...
}
```

**战斗机制**（`battleSystem.js`）：
- 命中率范围：20% ~ 95%
- 暴击率范围：5% ~ 50%
- 伤害波动：±10%
- 防御公式：防御/(防御+1000)

## 🚀 后续扩展

### 可添加功能

1. **技能系统**：不同境界解锁不同技能
2. **装备系统**：装备提供属性加成
3. **阵法系统**：阵法提供战斗加成
4. **宠物系统**：宠物参与战斗
5. **PVP排行榜**：玩家对战排名
6. **副本系统**：挑战NPC获得奖励

### 数值扩展

1. **元素属性**：金木水火土相生相克
2. **特殊状态**：中毒、眩晕、护盾等
3. **连击系统**：速度差距大时连续攻击
4. **反击系统**：防御高时有概率反击

## 📊 测试报告

运行测试脚本：
```bash
node test_battle_system.js
```

测试内容：
- ✅ 属性成长验证
- ✅ 战斗力计算验证
- ✅ 战斗经验影响测试
- ✅ 回合制战斗模拟
- ✅ 胜率统计
- ✅ 跨境界战斗测试

所有测试通过！✨
