# 仙灵环系统设计文档

## 概述

仙灵环系统是修仙游戏中的核心成长系统之一，通过仙灵环同时提升所有战斗属性。与天赋和经脉系统不同，仙灵环对所有8项战斗属性提供相同的加成。

## 核心特性

### 全属性加成
仙灵环同时作用于所有8项战斗属性：
- 血量（HP）
- 攻击（Attack）
- 防御（Defense）
- 速度（Speed）
- 暴击（Crit）
- 韧性（Toughness）
- 闪避（Dodge）
- 命中（Hit）

### 不影响修炼速度
仙灵环只影响战斗属性，不影响修炼速度（修为、战斗经验、灵石、功法）。

## 成长规则

### 累加式增长

仙灵环采用累加式增长，每次突破大境界时，在上一境界的基础上增加 `1000 × 2^(大境界-2)`。

| 境界 | 大境界 | 计算过程 | 加成值 |
|------|--------|---------|--------|
| 练气 | 1 | 初始值 | 500 |
| 筑基 | 2 | 500 + 1000×2^0 | 1,500 |
| 金丹 | 3 | 1500 + 1000×2^1 | 3,500 |
| 元婴 | 4 | 3500 + 1000×2^2 | 7,500 |
| 化神 | 5 | 7500 + 1000×2^3 | 15,500 |
| 炼虚 | 6 | 15500 + 1000×2^4 | 31,500 |
| 合体 | 7 | 31500 + 1000×2^5 | 63,500 |
| 大乘 | 8 | 63500 + 1000×2^6 | 127,500 |
| 渡劫 | 9 | 127500 + 1000×2^7 | 255,500 |
| 真仙 | 10 | 255500 + 1000×2^8 | 511,500 |

### 数学公式

**通用公式**（大境界 ≥ 2）：
```
加成 = 500 + 1000 × (2^0 + 2^1 + 2^2 + ... + 2^(n-2))
     = 500 + 1000 × (2^(n-1) - 1)
```

其中 `n` 为大境界级别。

**示例计算**：
- 大境界3（金丹）：`500 + 1000 × (2^2 - 1) = 500 + 3000 = 3500`
- 大境界4（元婴）：`500 + 1000 × (2^3 - 1) = 500 + 7000 = 7500`
- 大境界5（化神）：`500 + 1000 × (2^4 - 1) = 500 + 15000 = 15500`

## 属性加成机制

### 战斗属性计算

仙灵环加成会直接影响战斗属性的计算公式：

```
最终属性 = 基础值 × (1 + 境界系数) × (1 + 总加成) × (1 + 轮回加成) × (1 + 战斗倍率)
```

其中，`总加成` 包括：
- 天赋加成
- 经脉加成
- **仙灵环加成**（新增）
- 灵根加成（后续）
- 装备加成（后续）

### 加成叠加示例

以**速度**属性为例（仙灵环是唯一影响速度的系统）：

**练气1层**（仙灵环500）：
- 基础值：100
- 境界系数：1
- 天赋加成：0（无天赋影响速度）
- 经脉加成：0（无经脉影响速度）
- 仙灵环加成：500
- 总加成：500
- 速度：`100 × (1 + 1) × (1 + 500) = 100,200`

**筑基1层**（仙灵环1500）：
- 基础值：100
- 境界系数：2
- 总加成：1500
- 速度：`100 × (1 + 2) × (1 + 1500) = 450,300`

**金丹1层**（仙灵环3500）：
- 基础值：100
- 境界系数：3
- 总加成：3500
- 速度：`100 × (1 + 3) × (1 + 3500) = 1,400,400`

## 与其他系统的对比

### 三大加成系统对比

| 系统 | 初始加成 | 成长方式 | 影响范围 | 特点 |
|------|---------|---------|---------|------|
| 天赋 | 1000 | 每大境界翻倍 | 3个战斗属性 + 4个修炼速度 | 5种天赋，各司其职 |
| 经脉 | 2000 | 每大境界翻倍 | 3个战斗属性 + 4个修炼速度 | 8条经脉，各司其职 |
| 仙灵环 | 500 | 累加式增长 | 8个战斗属性 | 全属性加成 |

### 加成数值对比

| 境界 | 天赋加成 | 经脉加成 | 仙灵环加成 |
|------|---------|---------|-----------|
| 练气 | 1000 | 2000 | 500 |
| 筑基 | 4000 | 4000 | 1500 |
| 金丹 | 16000 | 8000 | 3500 |
| 元婴 | 64000 | 16000 | 7500 |
| 化神 | 256000 | 32000 | 15500 |

**观察**：
- 天赋加成增长最快（指数增长）
- 经脉加成增长中等（指数增长）
- 仙灵环加成增长较慢（累加式增长）

## 数据结构

### 仙灵环配置

```javascript
export const SPIRIT_RING_CONFIG = {
  // 基础加成值
  BASE_BONUS: 500,
  
  // 增长基数
  GROWTH_BASE: 1000,
  
  // 仙灵环信息
  INFO: {
    name: '仙灵环',
    description: '同时提升所有战斗属性',
    icon: '💍',
    affectedAttributes: ['hp', 'attack', 'defense', 'speed', 'crit', 'toughness', 'dodge', 'hit']
  }
}
```

## 核心函数

### 1. calculateSpiritRingBonus(level)

计算当前等级的仙灵环加成值。

**参数**：
- `level` (number): 当前境界等级

**返回**：
- (number): 仙灵环加成值

**示例**：
```javascript
calculateSpiritRingBonus(1)   // 500 (练气)
calculateSpiritRingBonus(11)  // 1500 (筑基)
calculateSpiritRingBonus(21)  // 3500 (金丹)
calculateSpiritRingBonus(31)  // 7500 (元婴)
```

### 2. calculateBattleAttributeBonuses(level)

计算所有战斗属性的仙灵环加成。

**参数**：
- `level` (number): 当前境界等级

**返回**：
- (Object): 各属性的仙灵环加成（所有属性加成相同）
  ```javascript
  {
    hp: 500,
    attack: 500,
    defense: 500,
    speed: 500,
    crit: 500,
    toughness: 500,
    dodge: 500,
    hit: 500
  }
  ```

### 3. getSpiritRingDetails(level)

获取仙灵环详细信息。

**参数**：
- `level` (number): 当前境界等级

**返回**：
- (Object): 仙灵环详细信息
  ```javascript
  {
    name: '仙灵环',
    description: '同时提升所有战斗属性',
    icon: '💍',
    bonus: 500,
    realmLevel: 1,
    affectedAttributes: ['hp', 'attack', 'defense', 'speed', 'crit', 'toughness', 'dodge', 'hit']
  }
  ```

### 4. getSpiritRingUpgradeInfo(oldLevel, newLevel)

计算突破后的仙灵环加成变化。

**参数**：
- `oldLevel` (number): 旧等级
- `newLevel` (number): 新等级

**返回**：
- (Object): 加成变化信息
  ```javascript
  {
    oldRealmLevel: 1,
    newRealmLevel: 2,
    oldBonus: 500,
    newBonus: 1500,
    isUpgraded: true,
    bonusIncrease: 1000
  }
  ```

### 5. getSpiritRingGrowthPreview(maxRealmLevel)

获取仙灵环成长预览。

**参数**：
- `maxRealmLevel` (number): 最大大境界级别（默认10）

**返回**：
- (Array): 成长预览数组
  ```javascript
  [
    { realmLevel: 1, level: 1, bonus: 500 },
    { realmLevel: 2, level: 11, bonus: 1500 },
    { realmLevel: 3, level: 21, bonus: 3500 },
    ...
  ]
  ```

## 集成说明

### 1. battleCalculator.js

在战斗属性计算中集成仙灵环加成：

```javascript
import { calculateBattleAttributeBonuses as calculateSpiritRingBonuses } from './spiritRingSystem.js'

// 在 calculateBattleAttributes 函数中
const spiritRingBonuses = calculateSpiritRingBonuses(level)
for (let attr in spiritRingBonuses) {
  attributeBonuses[attr] = (attributeBonuses[attr] || 0) + spiritRingBonuses[attr]
}
```

### 2. gameState.js

在游戏状态中添加仙灵环信息的 getter：

```javascript
import { getSpiritRingDetails } from '@/utils/spiritRingSystem.js'

// 在 getters 中
spiritRingDetails: (state) => {
  return getSpiritRingDetails(state.player.level)
}
```

## 数值验证

### 战斗属性（以速度为例）

**练气1层**（仙灵环500）：
- 速度：100,200

**筑基1层**（仙灵环1500）：
- 速度：450,300

**金丹1层**（仙灵环3500）：
- 速度：1,400,400

**元婴1层**（仙灵环7500）：
- 速度：3,000,400

### 综合加成（以血量为例）

**练气1层**（天赋1000 + 经脉2000 + 仙灵环500）：
- 总加成：3500
- 血量：`100 × (1 + 1) × (1 + 3500) = 700,200`

**筑基1层**（天赋4000 + 经脉4000 + 仙灵环1500）：
- 总加成：9500
- 血量：`100 × (1 + 2) × (1 + 9500) = 2,850,300`

**金丹1层**（天赋16000 + 经脉8000 + 仙灵环3500）：
- 总加成：27500
- 血量：`100 × (1 + 3) × (1 + 27500) = 11,000,400`

## 测试验证

运行测试脚本验证仙灵环系统：

```bash
node test_spirit_ring_system.js
```

测试内容包括：
1. 基础仙灵环加成计算
2. 战斗属性加成
3. 仙灵环详细信息
4. 仙灵环升级信息
5. 成长预览
6. 与天赋、经脉系统的叠加效果
7. 仙灵环配置验证
8. 加成增长率分析

## 设计理念

### 1. 全面性
- 仙灵环是唯一同时影响所有8项战斗属性的系统
- 特别是速度、暴击、韧性、闪避、命中这5项属性，只有仙灵环提供加成

### 2. 平衡性
- 初始加成较低（500），但覆盖面广
- 累加式增长，避免后期数值过于膨胀
- 与天赋、经脉系统形成互补

### 3. 简洁性
- 所有属性加成相同，易于理解
- 自动随境界提升，无需手动操作
- 计算公式简单明了

## 未来扩展

1. **仙灵环等级系统**：仙灵环可以单独升级
2. **仙灵环淬炼**：使用特殊材料强化仙灵环
3. **仙灵环共鸣**：与其他系统产生共鸣效果
4. **仙灵环特效**：不同境界的仙灵环有不同的视觉效果
5. **仙灵环套装**：多个仙灵环组合产生额外效果

## 版本历史

- **v1.1.0** (2025-10-30): 调整加成公式
  - 修改为累加式增长
  - 调整数值：练气500 → 筑基1500 → 金丹3500 → 元婴7500
  
- **v1.0.0** (2025-10-30): 初始版本
  - 实现仙灵环系统
  - 集成战斗属性加成
  - 与天赋、经脉系统叠加计算
