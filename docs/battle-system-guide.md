# 回合制战斗系统设计文档

## 一、系统概述

本系统实现了基于八项属性的真实回合制战斗，而非简单的战力数值比较。战斗结果由多个因素共同决定，包括命中、闪避、暴击、韧性等，使战斗更具真实性和策略性。

## 二、核心机制

### 2.1 八项属性

| 属性 | 图标 | 战力权重 | 战斗作用 |
|------|------|----------|----------|
| 攻击 | ⚔️ | 28% | 决定基础伤害 |
| 防御 | 🛡️ | 28% | 减少受到的伤害 |
| 血量 | ❤️ | 20% | 生命值，归零则失败 |
| 速度 | ⚡ | 6% | 决定出手顺序和闪避率 |
| 暴击 | 💥 | 6% | 影响暴击率和暴击伤害 |
| 韧性 | 💪 | 6% | 抵抗暴击 |
| 闪避 | 🌪️ | 3% | 躲避攻击的概率 |
| 命中 | 🎯 | 3% | 命中目标的概率 |

### 2.2 战斗流程

```
1. 比较双方速度，决定出手顺序
2. 每回合按速度顺序执行：
   a. 命中判定（基础90% + 命中加成 - 闪避加成）
   b. 闪避判定（基础5% + 闪避加成 + 速度加成）
   c. 暴击判定（基础10% + 暴击加成 - 韧性加成）
   d. 伤害计算：攻击 × (1 - 防御减伤) × 暴击倍率 × 随机波动
3. 检查血量，判定胜负
4. 最多100回合，超时判定失败
```

### 2.3 伤害计算公式

```javascript
// 防御减伤
defenseReduction = min(0.9, defense × 0.0005)

// 基础伤害
baseDamage = attack × (1 - defenseReduction)

// 暴击伤害
finalDamage = baseDamage × (isCrit ? 1.5 : 1.0) × (0.9 ~ 1.1随机)
```

### 2.4 概率计算

```javascript
// 命中率（10% ~ 95%）
hitRate = 0.9 + hit × 0.0005 - dodge × 0.0005 - speed × 0.0001

// 闪避率（0% ~ 50%）
dodgeRate = 0.05 + dodge × 0.0005 + speed × 0.0001

// 暴击率（0% ~ 80%）
critRate = 0.1 + crit × 0.0005 - toughness × 0.0005
```

## 三、爬塔系统

### 3.1 设计理念

- **起始难度**：第1层敌人战力为玩家的50%
- **难度增长**：每层战力提升1.5%
- **属性轮换**：每层强化一项属性，按顺序循环
- **随机性**：由于属性权重不同，实际难度有波动

### 3.2 属性轮换顺序

```
第1层：攻击 → 第2层：防御 → 第3层：血量 → 第4层：速度
→ 第5层：暴击 → 第6层：韧性 → 第7层：闪避 → 第8层：命中
→ 第9层：攻击（循环）...
```

### 3.3 敌人生成规则

```javascript
// 基础战力倍率
basePowerRatio = 0.5 + (floor - 1) × 0.015

// 被强化的属性
boostedAttr = attrOrder[(floor - 1) % 8]

// 属性计算
if (attr === boostedAttr) {
  enemyAttr = playerAttr × basePowerRatio × 1.3  // 强化属性额外+30%
} else {
  enemyAttr = playerAttr × basePowerRatio
}
```

### 3.4 难度波动分析

| 强化属性 | 战力影响 | 实战难度 | 特点 |
|----------|----------|----------|------|
| 攻击 | ⭐⭐⭐⭐⭐ | 高 | 战力高，伤害高 |
| 防御 | ⭐⭐⭐⭐⭐ | 高 | 战力高，耐打 |
| 血量 | ⭐⭐⭐⭐ | 中高 | 战力中等，但血厚 |
| 速度 | ⭐⭐⭐ | 中 | 先手优势，闪避高 |
| 暴击 | ⭐⭐⭐ | 中 | 可能打出高伤 |
| 韧性 | ⭐⭐⭐ | 中 | 抗暴击 |
| 闪避 | ⭐⭐ | 低 | 战力低，但可能躲避 |
| 命中 | ⭐⭐ | 低 | 战力低，不易Miss |

### 3.5 奖励机制

```javascript
// 通关奖励：对应层数的属性提升
rewardAttr = attrOrder[(floor - 1) % 8]
rewardRatio = floor × 0.005  // 每层0.5%

// 示例：通过第26层
// 奖励：防御提升13.0%（26 × 0.5%）
```

## 四、API 使用指南

### 4.1 执行战斗

```javascript
import { executeBattle } from '@/utils/battleCalculator'

// 玩家和敌人属性
const playerAttrs = { attack: 1000, defense: 500, hp: 5000, ... }
const enemyAttrs = { attack: 800, defense: 400, hp: 4000, ... }

// 执行战斗（详细模式）
const result = executeBattle(playerAttrs, enemyAttrs, true)

console.log(result)
// {
//   victory: true,           // 是否胜利
//   rounds: 15,              // 战斗回合数
//   playerFinalHp: 3200,     // 玩家剩余血量
//   enemyFinalHp: 0,         // 敌人剩余血量
//   battleLog: [...]         // 战斗日志（详细模式）
// }
```

### 4.2 生成爬塔敌人

```javascript
import { generateTowerEnemy } from '@/utils/battleCalculator'

// 生成第10层敌人
const enemy = generateTowerEnemy(playerAttrs, 10)

console.log(enemy)
// {
//   attack: 520,
//   defense: 260,
//   hp: 2600,
//   ...
//   floor: 10,               // 层数
//   boostedAttr: 'defense',  // 强化的属性
//   powerRatio: 0.635        // 战力倍率（63.5%）
// }
```

### 4.3 预估通关层数

```javascript
import { estimateTowerFloors } from '@/utils/battleCalculator'

// 预估玩家可通过的最高层数
const maxFloor = estimateTowerFloors(playerAttrs)
console.log(`预计可通过: ${maxFloor}层`)
```

### 4.4 获取奖励信息

```javascript
import { getTowerRewards } from '@/utils/battleCalculator'

// 获取通关奖励
const reward = getTowerRewards(26)
console.log(reward)
// {
//   attr: 'defense',
//   ratio: 0.13,
//   description: '防御提升13.0%'
// }
```

## 五、战斗示例

### 5.1 练气10层 vs 第1层

```
玩家属性：
  战斗力: 900350
  攻击: 550220  防御: 275110  血量: 2751100
  速度: 551100  暴击: 551100  韧性: 551100
  闪避: 110220  命中: 551100

敌人属性（第1层，强化攻击）：
  战斗力: 473284 (52.6%)
  攻击: 357643  防御: 137555  血量: 1375550
  速度: 275550  暴击: 275550  韧性: 275550
  闪避: 55110   命中: 275550

战斗结果：
  ✅ 胜利
  回合数: 41
  玩家剩余HP: 2173725/2751100 (79%)
```

### 5.2 练气10层 vs 第10层

```
敌人属性（第10层，强化防御）：
  战斗力: 586396 (65.1%)
  攻击: 349613  防御: 227421  血量: 1746948
  速度: 349948  暴击: 349948  韧性: 349948
  闪避: 69989   命中: 349948

战斗结果：
  ✅ 胜利
  回合数: 43
  玩家剩余HP: 2085186/2751100 (76%)
```

## 六、平衡性分析

### 6.1 预期通关层数

| 境界 | 战力 | 预计通关 | 奖励属性提升 |
|------|------|----------|--------------|
| 练气1层 | ~90K | ~8层 | ~4% |
| 练气10层 | ~900K | ~26层 | ~13% |
| 筑基1层 | ~1M | ~28层 | ~14% |
| 筑基10层 | ~10M | ~46层 | ~23% |
| 金丹1层 | ~12M | ~48层 | ~24% |

### 6.2 难度曲线

```
战力比例 = 50% + (层数 - 1) × 1.5%

第1层:  50.0%
第10层: 63.5%
第20层: 78.5%
第30层: 93.5%
第40层: 108.5%  ← 开始超过玩家战力
第50层: 123.5%
第67层: 149.0%  ← 理论极限（战力+50%）
```

### 6.3 属性轮换的影响

由于属性权重不同，实际难度会有±10%的波动：

- **攻击/防御层**（权重28%）：战力高，实战强
- **血量层**（权重20%）：战力中等，但耐久
- **速度/暴击/韧性层**（权重6%）：战力低，但有特殊优势
- **闪避/命中层**（权重3%）：战力最低，但可能出现意外

这种设计使得爬塔过程更有趣，玩家需要根据不同层数调整策略。

## 七、后续扩展

### 7.1 可能的优化方向

1. **技能系统**：添加主动技能和被动技能
2. **装备系统**：不同装备提供不同属性加成
3. **阵法系统**：提供战斗中的特殊效果
4. **天赋系统**：影响战斗计算的系数
5. **难度模式**：普通/困难/地狱模式

### 7.2 数值调整建议

如果觉得难度不合适，可以调整以下参数：

```javascript
// battleCalculator.js - BATTLE_SETTINGS

// 降低难度：
- 增加 BASE_HIT_RATE（提高命中率）
- 增加 CRIT_DAMAGE（提高暴击伤害）
- 减少 DEFENSE_REDUCTION（降低防御效果）

// 提高难度：
- 减少 BASE_HIT_RATE（降低命中率）
- 减少 CRIT_DAMAGE（降低暴击伤害）
- 增加 DEFENSE_REDUCTION（提高防御效果）
```

## 八、总结

本战斗系统通过八项属性的相互制衡，实现了真实的回合制战斗体验。爬塔系统的属性轮换机制使得每层都有不同的挑战，而不是单纯的数值碾压。这种设计既保证了游戏的可玩性，又为后续扩展留下了充足的空间。
